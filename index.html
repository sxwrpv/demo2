import React, { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import QRCode from "qrcode.react";
import { Html5QrcodeScanner } from "html5-qrcode";
import { ethers } from "ethers";

const contractAddress = "0xADdC9EafA31d0CeaB35d88Bed4657f77a47c55e8";
const contractABI = [ /* ABI JSON HERE */ ];

const Marketplace = () => {
  const [items, setItems] = useState([]);
  const [newItem, setNewItem] = useState({ name: "", price: "" });
  const [selectedQR, setSelectedQR] = useState(null);
  const [scanResult, setScanResult] = useState(null);
  const [walletAddress, setWalletAddress] = useState(null);
  const [contract, setContract] = useState(null);
  const [cart, setCart] = useState([]);

  useEffect(() => {
    if (window.ethereum) {
      window.ethereum.request({ method: "eth_accounts" }).then((accounts) => {
        if (accounts.length > 0) {
          setWalletAddress(accounts[0]);
        }
      });
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const marketplaceContract = new ethers.Contract(contractAddress, contractABI, signer);
      setContract(marketplaceContract);
    }
  }, []);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setNewItem({ ...newItem, [name]: value });
  };

  const addItem = async () => {
    if (newItem.name && newItem.price && contract) {
      try {
        const priceInWei = ethers.utils.parseEther(newItem.price);
        const tx = await contract.listItem(newItem.name, priceInWei);
        await tx.wait();
        setItems([...items, { ...newItem, id: Date.now() }]);
        setNewItem({ name: "", price: "" });
      } catch (error) {
        console.error("Error listing item:", error);
      }
    }
  };

  const addToCart = (item) => {
    setCart([...cart, item]);
  };

  const startScanner = () => {
    const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render((decodedText) => {
      setScanResult(decodedText);
      scanner.clear();
    });
  };

  const connectWallet = async () => {
    if (window.ethereum) {
      try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        setWalletAddress(accounts[0]);
      } catch (error) {
        console.error("Wallet connection failed", error);
      }
    } else {
      alert("MetaMask is required to connect your wallet");
    }
  };

  return (
    <div className="p-6 max-w-2xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">Marketplace</h1>
      <div className="mb-4 text-center">
        {walletAddress ? (
          <p className="text-green-500">Connected: {walletAddress}</p>
        ) : (
          <Button onClick={connectWallet}>Connect Wallet</Button>
        )}
      </div>

      <div className="flex gap-2 mb-4">
        <Input type="text" name="name" placeholder="Item name" value={newItem.name} onChange={handleInputChange} />
        <Input type="number" name="price" placeholder="Price (ETH)" value={newItem.price} onChange={handleInputChange} />
        <Button onClick={addItem}>List Item</Button>
      </div>

      <div className="grid gap-4">
        {items.map((item) => (
          <Card key={item.id} className="p-4 flex justify-between">
            <CardContent>
              <p className="font-semibold">{item.name}</p>
              <p className="text-gray-500">{item.price} ETH</p>
            </CardContent>
            <Button variant="outline" onClick={() => setSelectedQR(item.id)}>Get QR</Button>
            <Button variant="outline" onClick={() => addToCart(item)}>Add to Cart</Button>
          </Card>
        ))}
      </div>

      {selectedQR && (
        <div className="mt-6 text-center">
          <h2 className="text-lg font-bold">Transaction QR Code</h2>
          <QRCode value={`Transaction-${selectedQR}`} size={200} />
          <Button className="mt-2" onClick={() => setSelectedQR(null)}>Close</Button>
        </div>
      )}

      <div className="mt-6 text-center">
        <h2 className="text-lg font-bold">Scan QR Code</h2>
        <Button onClick={startScanner}>Start Scanner</Button>
        <div id="reader" className="mt-4"></div>
        {scanResult && <p className="mt-2 text-green-500">Scanned: {scanResult}</p>}
      </div>
    </div>
  );
};

const UserDashboard = () => {
  return (
    <div className="p-6 max-w-2xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">User Dashboard</h1>
      <p>Manage your listed items and transactions.</p>
    </div>
  );
};

const ItemListing = () => {
  return (
    <div className="p-6 max-w-2xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">Item Listings</h1>
      <p>View and browse items available for purchase.</p>
    </div>
  );
};

export { Marketplace, UserDashboard, ItemListing };

